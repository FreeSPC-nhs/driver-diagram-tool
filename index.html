<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Diagram Tool</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
    }

    /* App header */
    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: #005eb8; /* NHS blue */
      color: #ffffff;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    .app-header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
    }
    .app-header .info {
      margin: 0;
      font-size: 0.85rem;
      color: #e0ecff;
      max-width: 700px;
    }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: flex-end;
    }
    .header-buttons button {
      border-radius: 999px;
      border: 1px solid #ffffff;
      background: rgba(255,255,255,0.12);
      color: #ffffff;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .header-buttons button:hover {
      background: rgba(255,255,255,0.2);
    }

    main {
      display: grid;
      grid-template-columns: minmax(280px, 340px) minmax(0, 1fr);
      gap: 1.5rem;
      align-items: flex-start;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 1rem 1.25rem;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      font-weight: 500;
    }
    input[type="text"],
    select,
    textarea,
    input[type="color"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem 0.5rem;
      margin-bottom: 0.6rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="color"] {
      padding: 0;
      height: 2rem;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.8rem;
      font: inherit;
      cursor: pointer;
      background: #005eb8;
      color: #ffffff;
    }
    button.secondary {
      background: #e8edf5;
      color: #005eb8;
    }
    button.danger {
      background: #d5281b;
      color: #ffffff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }
    .nowrap {
      white-space: nowrap;
    }

    /* Diagram styles */
    #diagramCanvasWrapper {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 0.4rem;
      margin-bottom: 0.75rem;
      background: #fafafa;
      min-height: 350px;
    }
    #diagramCanvas {
      position: relative;
      width: 100%;
      min-height: 350px;
    }
    #diagramConnections {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #diagramColumns {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 3.5rem;
    }
    
    /* Columns now have a separate stack for their nodes */
    .diagram-column {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .diagram-column-stack {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly; /* spread nodes down the column */
    }

    /* For the Aim column, centre its single node vertically */
    .diagram-column.aim-column .diagram-column-stack {
      justify-content: center;
    }


    .diagram-column-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
      color: #666;
    }
    .diagram-node {
      position: relative;
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #d0d7de;
      padding: 0.25rem 1.2rem; /* extra space for +/- buttons */
      font-size: 0.8rem;
      line-height: 1.3;
      box-shadow: 0 1px 1px rgba(0,0,0,0.04);
      cursor: pointer;
    }
    .diagram-node.level-aim {
      border-left: 4px solid #005eb8;
    }
    .diagram-node.level-primary {
      border-left: 4px solid #007f3b;
    }
    .diagram-node.level-secondary {
      border-left: 4px solid #ff8c00;
    }
    .diagram-node.level-change {
      border-left: 4px solid #a31e5c;
    }
        .diagram-add {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid #c0c0c0;
      background: #ffffff;
      font-size: 11px;
      font-weight: 600;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #555;
    }

    .diagram-add-left {
      left: -10px;
    }
    .diagram-add-right {
      right: -10px;
    }
    .diagram-color-badge {
      position: absolute;
      bottom: 3px;
      right: 15px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.6);
      cursor: pointer;
    }

    /* Hide colour badges when exporting */
    .hide-badges .diagram-color-badge {
      display: none;
    }


    /* Legend styles */
    #legend {
      margin-top: 0.5rem;
    }
    .legend-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 0.25rem;
    }
    #legendList {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      margin-bottom: 0.15rem;
    }
    .legend-color-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #666;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.6);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      background: #f5f5f5;
    }

    @media (max-width: 900px) {
      header.app-header {
        flex-direction: column;
        align-items: stretch;
      }
      .header-buttons {
        justify-content: flex-start;
      }
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 0.25rem;
    }
    .collapsible-header span:first-child {
      flex: 1;
    }
    .collapsible-indicator {
      font-size: 0.8rem;
      color: #555;
      margin-left: 0.5rem;
    }
    .collapsible-section {
      margin-bottom: 0.75rem;
    }
    .collapsible-section.is-collapsed {
      display: none;
    }



    @media (max-width: 800px) {
      main {
        grid-template-columns: 1fr;
      }
      #diagramColumns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }


  </style>

  <!-- PapaParse for CSV import/export -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- html2canvas + html2pdf for PNG/PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div>
      <h1>Driver Diagram Tool</h1>
      <p class="info">
        Web-based driver diagram tool. Add an aim, primary/secondary drivers and change ideas,
        download as CSV, and export the visual diagram for reports. Colours and legend can be configured.
      </p>
    </div>
    <div class="header-buttons">
      <button id="btnToggleControls">Hide controls</button>
      <button id="btnToggleTable">Hide table</button>
      <button id="btnHeaderClear">Clear all</button>
      <button id="btnExportPng">Export chart (PNG)</button>
      <button id="btnExportPdf">Export PDF</button>
    </div>
  </header>

  <main>
    <!-- Left column: data entry + CSV + colours -->
    <section class="card" id="controlsPanel">
  <!-- Add items -->
  <h2 class="collapsible-header" data-target="sectionAddItems">
    <span>1. Add items</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionAddItems" class="collapsible-section">
    <label for="nodeText">Text</label>
    <textarea id="nodeText" placeholder="e.g. Reduce unplanned readmissions by 20% in 12 months"></textarea>

    <label for="nodeLevel">Level</label>
    <select id="nodeLevel">
      <option value="aim">Aim</option>
      <option value="primary">Primary driver</option>
      <option value="secondary">Secondary driver</option>
      <option value="change">Change idea</option>
    </select>

    <label for="nodeParent">Parent (optional)</label>
    <select id="nodeParent">
      <option value="">— None / top level —</option>
    </select>
    <p class="small">
      Typically the <strong>aim</strong> is at the centre, primary drivers connect to
      the aim, secondary drivers to a primary driver, and change ideas to a
      secondary (or primary) driver.
    </p>

    <label for="nodeColor">Colour (optional)</label>
    <select id="nodeColor">
      <option value="">No colour</option>
    </select>
    <p class="small">
      Colour options are defined below (e.g. “Primary 1”, “High impact”). If no colour is chosen,
      boxes will be white.
    </p>

    <div class="buttons">
      <button id="addNodeBtn">Add item</button>
      <button id="clearAllBtn" class="danger">Clear all</button>
    </div>

    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;" />
  </div>

  <!-- Import / export -->
  <h2 class="collapsible-header" data-target="sectionImportExport">
    <span>2. Import / export</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionImportExport" class="collapsible-section">
    <p class="small">
      Use CSV to save your driver diagram and reload it later. The CSV includes the
      colour associated with each box.
    </p>

    <div class="buttons">
      <button id="downloadCsvBtn" class="secondary">Download CSV</button>

      <label class="secondary nowrap" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.8rem;border-radius:4px;background:#e8edf5;color:#005eb8;cursor:pointer;">
        <span>Upload CSV</span>
        <input id="uploadCsvInput" type="file" accept=".csv" style="display:none;">
      </label>
    </div>

    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;" />
  </div>

  <!-- Colour options -->
  <h2 class="collapsible-header" data-target="sectionColourOptions">
    <span>3. Colour options</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionColourOptions" class="collapsible-section">
    <p class="small">
      Define optional colours you can apply to boxes. For example, you might use
      different colours for related primary drivers or to highlight priority areas.
      Click an existing colour in the list to edit it.
    </p>

    <label for="colorLabelInput">Label for colour</label>
    <input id="colorLabelInput" type="text" placeholder="e.g. Primary 1">

    <label for="colorValueInput">Colour value</label>
    <input id="colorValueInput" type="color" value="#fff7cc">

    <div class="buttons">
      <button id="addColorBtn" class="secondary">Add / update colour option</button>
    </div>

    <ul id="colorOptionsList" class="small" style="margin-top:0.5rem;padding-left:1rem;"></ul>
  </div>
</section>


    <!-- Right column: diagram + legend + table -->
    <section class="card" id="diagramArea">
      <h2>4. Diagram & items</h2>

      <!-- Export area: diagram + legend (used for PNG/PDF export) -->
      <div id="exportArea">
        <div id="diagramCanvasWrapper">
          <div id="diagramCanvas">
            <svg id="diagramConnections"></svg>
            <div id="diagramColumns"></div>
          </div>
        </div>

        <!-- Legend -->
        <div id="legend">
          <p class="legend-title">Legend</p>
          <p class="small" id="legendEmptyMessage">
            No colours defined yet. Add colours on the left to see them listed here.
          </p>
          <ul id="legendList"></ul>
        </div>
      </div>

      <h3 style="margin-top: 0.75rem;">Table view</h3>
      <p class="small" id="noItemsMessage">
        No items yet. Add an aim and some drivers on the left.
      </p>
      <div id="nodesTableWrapper" style="display:none;">
        <table>
          <thead>
            <tr>
              <th class="nowrap">ID</th>
              <th>Level</th>
              <th>Colour</th>
              <th>Parent</th>
              <th>Text</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="nodesTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="driver.js"></script>
</body>
</html>
