<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Diagram Tool</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
    }

    /* App header */
    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: #005eb8; /* NHS blue */
      color: #ffffff;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    .app-header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
    }
    .app-header .info {
      margin: 0;
      font-size: 0.85rem;
      color: #e0ecff;
      max-width: 700px;
    }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: flex-end;
    }
    .header-buttons button {
      border-radius: 999px;
      border: 1px solid #ffffff;
      background: rgba(255,255,255,0.12);
      color: #ffffff;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .header-buttons button:hover {
      background: rgba(255,255,255,0.2);
    }

    main {
      display: grid;
      grid-template-columns: minmax(280px, 340px) minmax(0, 1fr);
      gap: 1.5rem;
      align-items: flex-start;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 1rem 1.25rem;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      font-weight: 500;
    }
    input[type="text"],
    select,
    textarea,
    input[type="color"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem 0.5rem;
      margin-bottom: 0.6rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="color"] {
      padding: 0;
      height: 2rem;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.8rem;
      font: inherit;
      cursor: pointer;
      background: #005eb8;
      color: #ffffff;
    }
    button.secondary {
      background: #e8edf5;
      color: #005eb8;
    }
    button.danger {
      background: #d5281b;
      color: #ffffff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }
    .nowrap {
      white-space: nowrap;
    }

    /* Diagram styles */
    #diagramCanvasWrapper {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 0.4rem;
      margin-bottom: 0.75rem;
      background: #fafafa;
      min-height: 350px;
    }
    #diagramCanvas {
      position: relative;
      width: 100%;
      min-height: 350px;
    }
    #diagramConnections {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #diagramColumns {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 3.5rem;
    }
    
    /* Columns now have a separate stack for their nodes */
    .diagram-column {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .diagram-column-stack {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content:  space-between;
    }

    /* For the Aim column, centre its single node vertically */
    .diagram-column.aim-column .diagram-column-stack {
      justify-content: center;
    }


    .diagram-column-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
      color: #666;
    }
    .diagram-node {
      position: relative;
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #d0d7de;
      padding: 0.25rem 1.2rem; /* extra space for +/- buttons */
      font-size: 0.8rem;
      line-height: 1.3;
      box-shadow: 0 1px 1px rgba(0,0,0,0.04);
      cursor: pointer;
      display: flex;         
      align-items: center;
    }
    .diagram-node.level-aim {
      border-left: 4px solid #005eb8;
    }
    .diagram-node.level-primary {
      border-left: 4px solid #007f3b;
    }
    .diagram-node.level-secondary {
      border-left: 4px solid #ff8c00;
    }
    .diagram-node.level-change {
      border-left: 4px solid #a31e5c;
    }
        .diagram-add {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid #c0c0c0;
      background: #ffffff;
      font-size: 11px;
      font-weight: 600;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #555;
    }

    .diagram-add-left {
      left: -10px;
    }
    .diagram-add-right {
      right: -10px;
    }
     .diagram-color-badge {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 15px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.6);
      cursor: pointer;
    }

	/* Hide colour badges and add/connect buttons in exported images */
	.export-clean .diagram-color-badge,
	.export-clean .diagram-add {
	  display: none !important;
	}


    /* Hide colour badges when exporting */
    .hide-badges .diagram-color-badge {
      display: none;
    }


    /* Legend styles */
    #legend {
      margin-top: 0.5rem;
    }
    .legend-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 0.25rem;
    }
    #legendList {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      margin-bottom: 0.15rem;
    }
    .legend-color-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #666;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.6);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      background: #f5f5f5;
    }

    @media (max-width: 900px) {
      header.app-header {
        flex-direction: column;
        align-items: stretch;
      }
      .header-buttons {
        justify-content: flex-start;
      }
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 0.25rem;
    }
    .collapsible-header span:first-child {
      flex: 1;
    }
    .collapsible-indicator {
      font-size: 0.8rem;
      color: #555;
      margin-left: 0.5rem;
    }
    .collapsible-section {
      margin-bottom: 0.75rem;
    }
    .collapsible-section.is-collapsed {
      display: none;
    }

    /* Help / info modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.is-open {
      display: flex;
    }
    .modal-dialog {
      background: #ffffff;
      max-width: 820px;
      width: 90%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      padding: 1.25rem 1.5rem;
      overflow-y: auto;
      position: relative;
      font-size: 0.9rem;
    }
    .modal-dialog h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    .modal-dialog h3 {
      margin-bottom: 0.25rem;
      margin-top: 1rem;
      font-size: 1rem;
    }
    .modal-dialog p {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }
    .modal-dialog ul {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      padding-left: 1.25rem;
    }
    .modal-close-btn {
      position: absolute;
      top: 0.4rem;
      right: 0.6rem;
      border: none;
      background: transparent;
      color: #555;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .modal-close-btn:hover {
      color: #000;
    }
    .faq-question {
      font-weight: 600;
      margin-top: 0.5rem;
    }


    @media (max-width: 800px) {
      main {
        grid-template-columns: 1fr;
      }
      #diagramColumns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }


  </style>

  <!-- PapaParse for CSV import/export -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <!-- html2canvas + html2pdf for PNG/PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div>
      <h1>Driver Diagram Tool</h1>
      <p class="info">
        Web-based driver diagram tool. Add an aim, primary/secondary drivers and change ideas,
        download as CSV, and export the visual diagram for reports. Colours and legend can be configured.
      </p>
    </div>
    <div class="header-buttons">
	<button id="btnHelp">Help / info</button>      
	<button id="btnToggleControls">Hide controls</button>
      <button id="btnToggleTable">Hide table</button>
      <button id="toggleLegendBtn">Hide legend</button>
      <button id="btnHeaderClear">Clear all</button>
      <button id="btnExportPng">Export chart (PNG)</button>
      <button id="btnExportPdf">Export PDF</button>
    </div>
  </header>

  <main>
    <!-- Left column: data entry + CSV + colours -->
    <section class="card" id="controlsPanel">
 
  <!-- Import / export -->
  <h2 class="collapsible-header" data-target="sectionImportExport">
    <span>1. Import / export</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionImportExport" class="collapsible-section">
    <p class="small">
      Use CSV to save your driver diagram and reload it later. The CSV includes the
      colour associated with each box.
    </p>

    <div class="buttons">
      <button id="downloadCsvBtn" class="secondary">Save As CSV</button>

      <label class="secondary nowrap" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.8rem;border-radius:4px;background:#e8edf5;color:#005eb8;cursor:pointer;">
        <span>Upload CSV</span>
        <input id="uploadCsvInput" type="file" accept=".csv" style="display:none;">
      </label>
    </div>

    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;" />
  </div>

  <!-- Colour options -->
  <h2 class="collapsible-header" data-target="sectionColourOptions">
    <span>2. Colour options</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionColourOptions" class="collapsible-section">
    <p class="small">
      Define optional colours you can apply to boxes. For example, you might use
      different colours for related primary drivers or to highlight priority areas.
      Click an existing colour in the list to edit it.
    </p>

    <label for="colorLabelInput">Label for colour</label>
    <input id="colorLabelInput" type="text" placeholder="e.g. Primary 1">

    <label for="colorValueInput">Colour value</label>
    <input id="colorValueInput" type="color" value="#fff7cc">

    <div class="buttons">
      <button id="addColorBtn" class="secondary">Add / update colour option</button>
    </div>

    <ul id="colorOptionsList" class="small" style="margin-top:0.5rem;padding-left:1rem;"></ul>
  </div>

<!-- Diagram appearance -->
  <h2 class="collapsible-header" data-target="sectionAppearance">
    <span>3. Diagram appearance</span>
    <span class="collapsible-indicator">▾</span>
  </h2>
  <div id="sectionAppearance" class="collapsible-section">
    <p class="small">
      Adjust the size, spacing and text styling of the boxes in the diagram. These
      settings do not change the data, only how it looks.
    </p>

    <label for="boxHeightInput">Box height (px)</label>
    <input id="boxHeightInput" type="number" min="20" max="200" value="32">

    <label for="boxGapInput">Vertical gap between boxes (px)</label>
    <input id="boxGapInput" type="number" min="0" max="200" value="8">

    <label for="boxFontSizeInput">Text size (px)</label>
    <input id="boxFontSizeInput" type="number" min="8" max="32" value="13">

    <label for="boxFontFamilyInput">Font family</label>
<select id="boxFontFamilyInput">
  <option value="">Default (system)</option>

  <optgroup label="Sans-serif (recommended)">
    <option value='system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif'>System UI (modern)</option>
    <option value='"Frutiger", Arial, sans-serif'>Frutiger (if available)</option>
    <option value='"Segoe UI", Arial, sans-serif'>Segoe UI</option>
    <option value='Calibri, Arial, sans-serif'>Calibri</option>
    <option value='Arial, sans-serif'>Arial</option>
    <option value='Helvetica, Arial, sans-serif'>Helvetica</option>
    <option value='Verdana, Arial, sans-serif'>Verdana</option>
    <option value='Tahoma, Arial, sans-serif'>Tahoma</option>
    <option value='"Trebuchet MS", Arial, sans-serif'>Trebuchet MS</option>
  </optgroup>

  <optgroup label="Serif">
    <option value='Georgia, serif'>Georgia</option>
    <option value='"Times New Roman", Times, serif'>Times New Roman</option>
    <option value='Cambria, Georgia, serif'>Cambria</option>
  </optgroup>

  <optgroup label="Monospace">
    <option value='"Consolas", "Courier New", monospace'>Consolas</option>
    <option value='"Courier New", monospace'>Courier New</option>
  </optgroup>
</select>

	
     <label for="boxFontBoldInput" style="display:flex;align-items:center;gap:0.4rem;margin-top:0.25rem;">
      <input id="boxFontBoldInput" type="checkbox">
      <span>Bold text</span>
    </label>

    <div class="buttons">
      <button id="applyAppearanceBtn" class="secondary">Apply appearance</button>
    </div>
  </div>
</section>


    <!-- Right column: diagram + legend + table -->
    <section class="card" id="diagramArea">
      <h2>4. Diagram & items</h2>

      <!-- Export area: diagram + legend (used for PNG/PDF export) -->
      <div id="exportArea">
        <div id="diagramCanvasWrapper">
          <div id="diagramCanvas">
            <svg id="diagramConnections"></svg>
            <div id="diagramColumns"></div>
          </div>
        </div>

        <!-- Legend -->
	<div id="legendContainer">
	<div id="legend">
          <p class="legend-title">Legend</p>
          <p class="small" id="legendEmptyMessage">
            No colours defined yet. Add colours on the left to see them listed here.
          </p>
          <ul id="legendList"></ul>
        </div>
	</div>
      </div>

      <h3 style="margin-top: 0.75rem;">Table view</h3>
      <p class="small" id="noItemsMessage">
        No items yet. Add an aim and some drivers on the left.
      </p>
      <div id="nodesTableWrapper" style="display:none;">
        <table>
          <thead>
            <tr>
              <th class="nowrap">ID</th>
              <th>Level</th>
              <th>Colour</th>
              <th>Parent</th>
              <th>Text</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="nodesTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Help / FAQ and About modal -->
  <div id="helpOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
      <button class="modal-close-btn" id="helpCloseBtn" aria-label="Close help">×</button>

      <h2 id="helpModalTitle">Help & information</h2>

<h3>Using this tool</h3>
<p>
  This web-based driver diagram tool lets you create and edit a driver diagram made up of an
  <strong>aim</strong>, <strong>primary drivers</strong>, <strong>secondary drivers</strong>,
  and <strong>change ideas</strong>. You can edit items directly, manage colours, and export
  the diagram for reports or presentations.
</p>

<p class="faq-question">1. Understanding the diagram structure</p>
<ul>
  <li><strong>Aim</strong>: the overall goal you are trying to achieve (left-hand column).</li>
  <li><strong>Primary drivers</strong>: the main factors that directly contribute to the aim.</li>
  <li><strong>Secondary drivers</strong>: factors that influence the primary drivers.</li>
  <li><strong>Change ideas</strong>: specific actions or tests of change that influence drivers.</li>
</ul>

<p>
  The diagram cause and effect from right to left: if we implement these
  <strong>change ideas</strong>, they should influence our
  <strong>secondary and primary drivers</strong>, which together help us achieve the
  <strong>aim</strong>.
</p>

<p class="faq-question">2. Adding and editing items</p>
<ul>
  <li>Use the <strong>diagram table</strong> or <strong>diagram columns</strong> to add new items.</li>
  <li>Click on an item’s text to <strong>edit it directly</strong>.</li>
  <li>Select the appropriate <strong>level</strong> (Aim, Primary driver, Secondary driver, or Change idea).</li>
  <li>Items automatically appear in the correct column and connect to their parent.</li>
</ul>

<p class="faq-question">3. Reordering and organising</p>
<ul>
  <li>Items can be moved within their column to change their visual order.</li>
  <li>The diagram automatically redraws connections as items are updated.</li>
  <li>This allows the diagram to evolve as your thinking develops.</li>
</ul>

<p class="faq-question">4. Using colours</p>
<ul>
  <li>Colours can be used to group related drivers or change ideas.</li>
  <li>You can <strong>add new colours</strong>, <strong>rename existing colours</strong>, or
      <strong>delete colours</strong> using the colour management controls.</li>
  <li>Applying a colour helps visually highlight themes, workstreams, or priorities.</li>
</ul>

<p class="faq-question">5. Editing and deleting</p>
<ul>
  <li>Click on an item to edit its text.</li>
  <li>Use the delete option to remove items you no longer need.</li>
  <li>Deleting an item will also remove its connections from the diagram.</li>
</ul>

<p class="faq-question">6. Exporting and sharing</p>
<ul>
  <li>The diagram can be exported for use in reports, presentations, or documentation.</li>
  <li>This makes it easy to share your thinking with colleagues and stakeholders.</li>
</ul>

<p>
  This tool is designed to support continuous learning. As you test change ideas and review
  data (for example using run charts or SPC), you can update the diagram to reflect your
  latest understanding.
</p>
<h3>Further information</h3>

<p>
  If you would like to learn more about driver diagrams and how they are used in
  quality improvement, the following resources provide clear and authoritative guidance:
</p>

<ul>
  <li>
    <a href="https://www.england.nhs.uk/improvement-hub/wp-content/uploads/sites/44/2018/06/An-example-of-driver-diagrams-1.pdf"
       target="_blank"
       rel="noopener"
       title="NHS England guidance explaining what driver diagrams are, how to build them, and how they are used in NHS quality improvement">
      <strong>NHS England – Driver diagrams</strong>
    </a><br>
    Practical NHS guidance on creating and using driver diagrams in quality improvement work.
  </li>

  <li>
    <a href="https://www.ihi.org/resources/Pages/Tools/Driver-Diagram.aspx"
       target="_blank"
       rel="noopener"
       title="Institute for Healthcare Improvement guidance on the purpose, structure, and use of driver diagrams">
      <strong>Institute for Healthcare Improvement (IHI) – Driver Diagrams</strong>
    </a><br>
    A widely recognised international reference explaining the purpose and structure of driver diagrams.
  </li>

  <li>
    <a href="https://www.ihi.org/resources/Pages/HowtoImprove/default.aspx"
       target="_blank"
       rel="noopener"
       title="Overview of the Model for Improvement, including aims, measures, and PDSA cycles">
      <strong>The Model for Improvement</strong>
    </a><br>
    Background reading on how driver diagrams fit alongside PDSA cycles and measurement.
  </li>
</ul>

<p>
  These resources can help you get the most value from this tool.

    </div>
  </div>

  <script src="driver.js"></script>
</body>
</html>

